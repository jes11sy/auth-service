# üîÑ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

## –ß—Ç–æ —ç—Ç–æ?

**–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ **–î–û –∏—Å—Ç–µ—á–µ–Ω–∏—è**, –∞ –Ω–µ –ø–æ—Å–ª–µ 401 –æ—à–∏–±–∫–∏.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### 1. **Guard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è**

`CookieJwtAuthGuard` –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `exp` (expiration):

```typescript
// –ï—Å–ª–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –º–µ–Ω—å—à–µ 5 –º–∏–Ω—É—Ç
if (timeLeft < 5 * 60 * 1000) {
  request.__needsProactiveRefresh = true
}
```

### 2. **Interceptor –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞**

`ProactiveRefreshInterceptor` –≤–∏–¥–∏—Ç —Ñ–ª–∞–≥ `__needsProactiveRefresh` –∏:

1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ **httpOnly cookies**
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ù–µ—Ç 401 –æ—à–∏–±–æ–∫** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚úÖ **–ü–ª–∞–≤–Ω—ã–π UX** ‚Äî –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç—Å—è  
‚úÖ **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞** ‚Äî –Ω–µ –Ω—É–∂–Ω–æ retry  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî —Ç–æ–∫–µ–Ω—ã –≤ httpOnly cookies

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–æ—Ä–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–ò–∑–º–µ–Ω–∏—Ç—å –≤ `cookie-jwt-auth.guard.ts`:

```typescript
const REFRESH_THRESHOLD = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
```

### –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤

üîí **–ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –≤ –∫–æ–¥–µ**:

- **Access token**: `15m` (15 –º–∏–Ω—É—Ç) ‚Äî –≤ `auth.module.ts`
- **Refresh token**: `7d` (7 –¥–Ω–µ–π) ‚Äî –≤ `auth.service.ts` –∏ `proactive-refresh.interceptor.ts`

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏:

```typescript
// auth.module.ts:26
expiresIn: '15m', // Access token

// auth.service.ts:210, 328
expiresIn: '7d', // Refresh token
const refreshTTL = 7 * 24 * 60 * 60; // —Å–µ–∫—É–Ω–¥—ã

// proactive-refresh.interceptor.ts:48
expiresIn: '7d', // Refresh token
```

## –õ–æ–≥–∏

–ü—Ä–∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤ –ª–æ–≥–∞—Ö:

```
[CookieJwtAuthGuard] üîÑ Token expires soon, marking for proactive refresh
[ProactiveRefreshInterceptor] üîÑ Proactively refreshed tokens for user 6 (admin)
```

## –í–∞–∂–Ω–æ

- –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å httpOnly cookies** (`X-Use-Cookies: true`)
- –ù–µ –º–µ—à–∞–µ—Ç —Å—Ç–∞—Ä–æ–º—É –º–µ—Ö–∞–Ω–∏–∑–º—É (401 ‚Üí manual refresh)
- –ö–ª–∏–µ–Ω—Ç **–Ω–µ –∑–∞–º–µ—á–∞–µ—Ç** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –≤—Å—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ

