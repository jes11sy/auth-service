# Исправления безопасности Auth Service

## Что исправлено:

### 1. ✅ Инвалидация Refresh токенов через Redis
- Refresh токены теперь хранятся в Redis
- При logout все refresh токены пользователя удаляются
- При refresh старый токен отзывается (одноразовое использование)
- Новый refresh токен возвращается в каждом /refresh ответе

### 2. ✅ Защита от Brute-Force атак
- 10 попыток входа на 10 минут блокировка по связке `login:role`
- После каждой неудачной попытки показывается количество оставшихся
- При успешном входе счетчик сбрасывается
- Время блокировки показывается в сообщении об ошибке

### 3. ✅ Убрано логирование чувствительных данных
- Логин больше не логируется в ошибках валидации
- В логах только роль пользователя без персональных данных

## Обновлены фронтенды:

### Frontend Callcentre (`src/lib/auth.ts`)
- Добавлен interceptor с очередью запросов
- Автоматическое сохранение новых refresh токенов
- Поддержка ротации токенов

### Frontend Dir (`src/lib/api.ts`) 
- Новый API клиент с auto-refresh
- Обертка `apiClient` для обратной совместимости
- Все токены автоматически обновляются

### Frontend Master (`lib/api.ts`)
- Новый API клиент с auto-refresh
- Обертка `apiClient` для Pages Router
- Совместимость со старым auth_token

## Результат:

- ❌ **Было**: Пользователей выкидывало каждые 15 минут
- ✅ **Стало**: Токены обновляются автоматически и прозрачно

## Redis настройки:

Добавить в `.env`:
```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

## Запуск:

```bash
# Auth service
cd api-services/auth-service
npm install
npm run start:dev

# Убедитесь что Redis запущен
docker run -d -p 6379:6379 redis:7-alpine
```

## Проверка:

1. Логин → токены сохранены в Redis
2. Работа 15+ минут → автообновление
3. 10 неудачных попыток → блокировка на 10 минут  
4. Logout → все токены удалены из Redis

