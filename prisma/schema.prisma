generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Существующие таблицы аутентификации
model CallcentreAdmin {
  id        Int      @id @default(autoincrement())
  login     String   @unique
  password  String
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("callcentre_admin")
}

model CallcentreOperator {
  id         Int      @id @default(autoincrement())
  name       String
  login      String   @unique
  password   String
  city       String
  status     String
  statusWork String   @map("status_work")
  passport   String?
  contract   String?
  dateCreate DateTime @map("date_create")
  note       String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  sipAddress String?  @map("sip_address")

  // ✅ ИСПРАВЛЕНИЕ PERF-002: Performance Indexes
  @@index([status])              // Для быстрой фильтрации по статусу
  @@index([status, login])       // Составной индекс для login query с проверкой статуса
  @@index([city])                // Для фильтрации по городу
  @@index([statusWork])          // Для фильтрации по статусу работы
  @@map("callcentre_operator")
}

model Director {
  id          Int      @id @default(autoincrement())
  cities      String[] // Массив городов
  name        String
  login       String   @unique
  password    String
  contractDoc String?  @map("contract_doc")
  passportDoc String?  @map("passport_doc")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("director")
}

model Master {
  id          Int      @id @default(autoincrement())
  cities      String[] // Массив городов
  name        String
  login       String?  @unique
  password    String?
  passportDoc String?  @map("passport_doc")
  contractDoc String?  @map("contract_doc")
  statusWork  String   @map("status_work")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  chatId      String?  @map("chat_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // ✅ ИСПРАВЛЕНИЕ PERF-002: Performance Indexes
  @@index([statusWork])          // Для проверки статуса работы при login
  @@index([statusWork, login])   // Составной индекс для login query с проверкой statusWork
  @@map("master")
}

// Enum для типов пользователей
enum UserRole {
  CALLCENTRE_ADMIN
  CALLCENTRE_OPERATOR
  DIRECTOR
  MASTER
}

// Audit logs для безопасности и мониторинга
model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  eventType String   @db.VarChar(100)
  userId    Int?
  role      String?  @db.VarChar(50)
  login     String?  @db.VarChar(255)
  ip        String   @db.VarChar(45)
  userAgent String   @db.Text
  success   Boolean
  metadata  Json?    @db.JsonB

  @@index([userId, timestamp(sort: Desc)])
  @@index([eventType, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

